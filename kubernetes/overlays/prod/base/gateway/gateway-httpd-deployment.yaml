---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-httpd
spec:
  strategy:
    type: RollingUpdate
  template:
    spec:
      containers:
        - name: gateway-httpd
          ports:
            - containerPort: 443
              protocol: TCP
          env:
            - name: LISTEN_PORT
              value: "80"
            - name: SERVICE_PORT
              value: "443"
            - name: SERVICE_PROTOCOL
              value: https
            - name: SERVICE_REDIRECT_URL_PATH
              value: /app/redirect_uri
            - name: OIDC_CRYPTO_PASS_PHRASE
              valueFrom:
                secretKeyRef:
                  name: oidc
                  key: crypto_passphrase
            - name: OIDC_CLIENT_ID
              value: app
            - name: OIDC_CLIENT_SECRET
              valueFrom:
                secretKeyRef:
                  name: oidc
                  key: client_secret
            - name: OIDC_DEFAULT_URL_PATH
              value: /app/
            - name: KEYCLOAK_SERVICE_URL
              value: https://gateway-keycloak/
            - name: LOCATION_API_URL
              value: http://hmi-server:3000/api/
            - name: LOCATION_APP_URL
              value: http://hmi-client:8080/app/
            - name: LOCATION_FUNMAN_URL
              value: http://funman:8190/
            - name: CONFIGURATION_API_URL
              value: http://hmi-server:3000/configuration/
            - name: LOCATION_LLM_URL
              value: http://jupyter-llm:3050/
            - name: LOCATION_LLM_WS_URL
              value: ws://jupyter-llm:3050/
            - name: ADMIN_KEYCLOAK_API_URL
              value: http://gateway-admin-keycloak:8081/api/
            - name: ADMIN_KEYCLOAK_UI_URL
              value: http://gateway-admin-keycloak-ui:80/app/
          volumeMounts:
            - name: config-locations-volume
              mountPath: /usr/local/apache2/conf/default/locations
            - name: certificates-volume
              mountPath: /certificates
            - name: htdocs-volume
              mountPath: /usr/local/apache2/htdocs
      volumes:
        - name: htdocs-volume
          configMap:
            name: gateway-httpd-htdocs
        - name: config-locations-volume
          configMap:
            name: gateway-httpd-config-locations
        - name: certificates-volume
          configMap:
            name: gateway-certificates
            defaultMode: 0644
