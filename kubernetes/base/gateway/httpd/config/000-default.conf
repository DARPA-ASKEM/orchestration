ServerName ${SERVICE_FQDN}

# Include ssl-setup if required
Include /usr/local/apache2/conf/default/ssl/ssl-setup.conf

<VirtualHost *:${LISTEN_PORT}>
    DocumentRoot "/usr/local/apache2/htdocs"
    ServerName ${SERVICE_FQDN}
    ServerAdmin you@example.com

    ErrorLog /proc/self/fd/1
    CustomLog /proc/self/fd/2 combined
    LogLevel debug

    Header set OIDC_access_token "%{OIDC_access_token}e" env=OIDC_access_token
    Header set OIDC_access_token_expires "%{OIDC_access_token_expires}e" env=OIDC_access_token_expires

    RequestHeader set X-Forwarded-Proto "${SERVICE_PROTOCOL}" early
    RequestHeader set X-Forwarded-Port ${SERVICE_PORT}

    ProxyPreserveHost On

    OIDCProviderMetadataURL ${KEYCLOAK_SERVICE_URL}/realms/${REALM}/.well-known/openid-configuration
    OIDCSSLValidateServer off
    OIDCRedirectURI ${SERVICE_PROTOCOL}://${SERVICE_FQDN}:${SERVICE_PORT}${SERVICE_REDIRECT_URL_PATH}
    OIDCDefaultURL ${SERVICE_PROTOCOL}://${SERVICE_FQDN}:${SERVICE_PORT}${OIDC_DEFAULT_URL_PATH}
    OIDCCryptoPassphrase ${OIDC_CRYPTO_PASS_PHRASE}
    OIDCClientID ${OIDC_CLIENT_ID}
    OIDCClientSecret ${OIDC_CLIENT_SECRET}
    OIDCScope "openid email profile"
    OIDCXForwardedHeaders X-Forwarded-Host X-Forwarded-Port X-Forwarded-Proto
    OIDCPassClaimsAs headers
    OIDCSessionInactivityTimeout 400

    OIDCRemoteUserClaim sub
    OIDCPassClaimsAs environment

    OIDCInfoHook userinfo

    # See fast if we accumulate state cookies
    LimitRequestFieldSize 4096

    Header setifempty Cache-Control "max-age=0, must-revalidate"

    RedirectTemp /logout ${SERVICE_PROTOCOL}://${SERVICE_FQDN}:${SERVICE_PORT}${SERVICE_REDIRECT_URL_PATH}?logout=${SERVICE_PROTOCOL}://${SERVICE_FQDN}:${SERVICE_PORT}/app/

    # Keycloak proxy
    <Location /auth/>
        ProxyPass ${KEYCLOAK_SERVICE_URL}
        ProxyPassReverse ${KEYCLOAK_SERVICE_URL}
    </Location>
    # Bearer token check
    <Location /silent-check-sso.html>
        AuthType openid-connect
        Require valid-user
    </Location>

    # Include ssl-setup if required
    Include /usr/local/apache2/conf/default/ssl/ssl-proxy.conf

    # Application and API Services
    Include /usr/local/apache2/conf/default/locations/*.conf
</VirtualHost>

# Private Keycloak administration
<VirtualHost *:${LISTEN_PORT}>
    DocumentRoot "/usr/local/apache2/htdocs"
    ServerName ${KEYCLOAK_ADMIN_FQDN}
    ServerAdmin you@example.com

    ErrorLog /proc/self/fd/1
    CustomLog /proc/self/fd/2 combined
    LogLevel debug

    RequestHeader set X-Forwarded-Proto "${SERVICE_PROTOCOL}" early
    RequestHeader set X-Forwarded-Port ${SERVICE_PORT}

    # Include ssl-setup if required
    Include /usr/local/apache2/conf/default/ssl/ssl-proxy.conf

    <Location />
        ProxyPass ${KEYCLOAK_SERVICE_URL}
        ProxyPassReverse ${KEYCLOAK_SERVICE_URL}
    </Location>
</VirtualHost>
