---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-spicedb
spec:
  template:
    spec:
      containers:
        - name: gateway-spicedb
          args:
            - serve
            - --datastore-engine=postgres
            - --datastore-conn-uri=postgres://$(DB_USERNAME):$(DB_PASSWORD)@$(DB_URL_HOST)/spicedb?sslmode=disable
          env:
            - name: SPICEDB_GRPC_PRESHARED_KEY
              value: rRi76idYiFwYHpTJsG4wNVKKZxPBfbAHzgq3uC9B3WHD8aJAo87.v76jwH8T
            - name: DB_URL_HOST
              value: gateway-spicedb-postgres:5432
            - name: DB_USERNAME
              value: spicedb
            - name: DB_PASSWORD
              value: spicedb
      initContainers:
        - name: gateway-spicedb-migrate
          image: gateway-spicedb-image
          args:
            - migrate
            - head
            - --datastore-engine=postgres
            - --datastore-conn-uri=postgres://$(DB_USERNAME):$(DB_PASSWORD)@$(DB_URL_HOST)/spicedb?sslmode=disable
          env:
            - name: SPICEDB_GRPC_PRESHARED_KEY
              value: rRi76idYiFwYHpTJsG4wNVKKZxPBfbAHzgq3uC9B3WHD8aJAo87.v76jwH8T
            - name: DB_URL_HOST
              value: gateway-spicedb-postgres:5432
            - name: DB_USERNAME
              value: spicedb
            - name: DB_PASSWORD
              value: spicedb
