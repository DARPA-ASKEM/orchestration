---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-spicedb
spec:
  template:
    spec:
      containers:
        - name: gateway-spicedb
          args:
            - serve
            - --datastore-engine=postgres
            - --datastore-conn-uri=$(DATASTORE_CONN_URL)
          env:
            - name: SPICEDB_GRPC_PRESHARED_KEY
              value: somerandomkeyhere
            - name: DATASTORE_CONN_URL
              value: postgres://spicedb:spicedb@gateway-spicedb-postgres:5432/spicedb?sslmode=disable
      initContainers:
        - name: gateway-spicedb-migrate
          image: gateway-spicedb-image
          args:
            - migrate
            - head
            - --datastore-engine=postgres
            - --datastore-conn-uri=$(DATASTORE_CONN_URL)
          env:
            - name: SPICEDB_GRPC_PRESHARED_KEY
              value: somerandomkeyhere
            - name: DATASTORE_CONN_URL
              value: postgres://spicedb:spicedb@gateway-spicedb-postgres:5432/spicedb?sslmode=disable
